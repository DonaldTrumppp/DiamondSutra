<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Text Reader with Sync</title>
  <style>
    body {
      font-family: sans-serif;
      line-height: 1.6;
      margin: 20px;
    }
    #content {
      white-space: pre-wrap;
      margin-bottom: 80px;
    }
    #nav {
      position: fixed;
      bottom: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
    }
    button {
      padding: 8px 12px;
    }
  </style>
</head>
<body>
  <h1>My Text Reader</h1>
    <div> <p id="userEmail">Not signed in</p>
    </div>
  <div id="content"></div>
  <div id="nav">
    <button id="loginBtn">Login with Google</button>

    <button id="prevBtn">Prev</button>
    <button id="nextBtn">Next</button>

  </div>

  
  
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ðŸ”¹ Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC9FBAPW12b2mXQ3-HRrlln7lrxgFQ6cyI",
      authDomain: "diamondsutra-30da1.firebaseapp.com",
      projectId: "diamondsutra-30da1",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Auth ---
    const provider = new GoogleAuthProvider();

    async function signInWithGoogle() {
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        document.getElementById("userEmail").textContent = `Signed in as: ${user.email}`;
        return user;
    } catch (error) {
        console.error("Login failed:", error);
    }
    }


    // Listen for auth changes
    onAuthStateChanged(auth, (user) => {
    const emailElement = document.getElementById("userEmail");
    if (user) {
        emailElement.textContent = `Signed in as: ${user.email || "Anonymous"}`;
    } else {
        emailElement.textContent = "Not signed in";
    }
    });

    
    // Ensure signed in
    async function ensureSignedIn() {
    return new Promise((resolve) => {
        onAuthStateChanged(auth, async (user) => {
        if (!user) {
            user = await signInWithGoogle();
        }
        resolve(user);
        });
    });
    }


    // --- Firestore helpers ---
    function progressDocRef(uid) {
      return doc(db, "users", uid, "reading", "progress");
    }

    let saveTimer = null;
    function saveProgress(uid, sectionId, offsetPx) {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async () => {
        await setDoc(progressDocRef(uid), {
          currentSectionId: sectionId,
          offsetPx,
          updatedAt: serverTimestamp()
        }, { merge: true });
      }, 400);
    }

    async function subscribeProgress(uid, onUpdate) {
      return onSnapshot(progressDocRef(uid), (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          onUpdate(data.currentSectionId, data.offsetPx || 0);
        }
      });
    }

    // --- Text splitting ---
    function splitIntoSections(fullText) {
      const parts = fullText.split(/(?=\dï¼Ž)/g); // keep "nï¼Ž"
      return parts.map((content, idx) => ({
        id: `section-${idx + 1}`,
        title: content.match(/^\dï¼Ž/)?.[0] ?? `Section ${idx + 1}`,
        content
      }));
    }

    // --- UI rendering ---
    let sections = [];
    let currentIndex = 0;

    function renderSection(index) {
      const section = sections[index];
      document.getElementById("content").textContent = section.content;
      currentIndex = index;
      window.scrollTo(0, 0);
    }

    function findIndexById(id) {
      return sections.findIndex(s => s.id === id);
    }

    function onScroll(uid) {
      const offsetPx = window.scrollY || document.documentElement.scrollTop || 0;
      const currentSectionId = sections[currentIndex]?.id;
      if (currentSectionId) {
        saveProgress(uid, currentSectionId, offsetPx);
      }
    }

    // --- Init ---
    async function initReader() {
        const response = await fetch("text.txt"); // load your text file
        const fullText = await response.text();
        sections = splitIntoSections(fullText);

        const user = await ensureSignedIn();
        renderSection(0);

        await subscribeProgress(user.uid, (sectionId, offsetPx) => {
            const idx = findIndexById(sectionId);
            if (idx >= 0 && idx !== currentIndex) {
            renderSection(idx);
            }
            window.requestAnimationFrame(() => {
            window.scrollTo(0, offsetPx || 0);
            });
        });

        window.addEventListener("scroll", () => onScroll(user.uid), { passive: true });

        document.getElementById("nextBtn").addEventListener("click", () => {
            if (currentIndex < sections.length - 1) {
            renderSection(currentIndex + 1);
            saveProgress(user.uid, sections[currentIndex].id, 0);
            }
        });
        document.getElementById("prevBtn").addEventListener("click", () => {
            if (currentIndex > 0) {
            renderSection(currentIndex - 1);
            saveProgress(user.uid, sections[currentIndex].id, 0);
            }
        });
        
        }
    
    document.getElementById("loginBtn").addEventListener("click", signInWithGoogle);
    initReader();
    
  </script>
</body>
</html>
